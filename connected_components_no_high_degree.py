from parse import get_lines, parse_line, get_data
from rdf import TYPE, LABEL, RELATES, RELATED_BY, NUM_LINES, is_individual, is_datetime
from utils import dump_obj, get_obj, histogram
from union_find import UnionFind

metadata_uris = get_obj('metadata_uris.pkl')
uridegree = get_obj('uri_to_degree.pkl')

HIGH_DEGREE_MIN = 100
high_degree_uris = set(uri for (uri, degree) in uridegree.items() if degree > HIGH_DEGREE_MIN)

sets = UnionFind()
line_count = 0
for s, p, o in map(parse_line, get_data()):
    line_count += 1
    if line_count % 100000 == 0:
        print(line_count, '/', NUM_LINES)

    is_subject_individual = is_individual(s)
    is_object_individual = is_individual(o)

    should_ignore_subject = (not is_subject_individual) or (s in metadata_uris) or (s in high_degree_uris)
    should_ignore_object = (not is_object_individual) or (o in metadata_uris) or (o in high_degree_uris)

    if not should_ignore_subject:
        sets.add(s)
    if not should_ignore_object:
        sets.add(o)
    if (not should_ignore_subject) and (not should_ignore_object):
        sets.union(s, o)

components = sets.components()
h = histogram(map(len, components))
print(h)
# {1498104: 1, 6: 6270, 1: 157073, 36: 114, 5: 15759, 4: 62352, 43: 71, 16: 537, 13: 1528, 18: 448, 33: 101, 2: 50365, 19: 311, 3: 16557, 193: 2, 7: 5318, 68: 18, 9: 2327, 49: 59, 15: 594, 25: 224, 11: 1790, 107: 3, 10: 2649, 63: 14, 40: 99, 46: 55, 8: 3821, 24: 237, 56: 36, 42: 99, 22: 303, 37: 98, 38: 138, 67: 32, 12: 3283, 310: 1, 29: 167, 51: 40, 27: 189, 32: 126, 94: 7, 249: 1, 39: 62, 14: 928, 21: 323, 57: 28, 26: 235, 48: 49, 31: 96, 17: 413, 129: 3, 23: 217, 20: 285, 30: 188, 99: 5, 84: 7, 104: 5, 62: 26, 85: 13, 58: 40, 66: 28, 89: 10, 34: 140, 182: 2, 59: 37, 102: 6, 72: 18, 41: 66, 184: 2, 105: 8, 78: 14, 96: 9, 54: 47, 28: 202, 77: 16, 421: 1, 52: 43, 121: 3, 123: 2, 45: 52, 65: 34, 50: 69, 90: 7, 221: 2, 101: 6, 74: 11, 60: 32, 35: 101, 139: 5, 126: 3, 53: 39, 97: 13, 69: 19, 73: 22, 79: 8, 149: 3, 92: 4, 82: 13, 47: 32, 376: 1, 122: 3, 111: 4, 144: 1, 91: 8, 80: 11, 44: 57, 124: 2, 267: 1, 151: 2, 95: 10, 61: 30, 76: 12, 148: 1, 146: 2, 83: 10, 103: 4, 98: 9, 356: 1, 64: 30, 125: 5, 55: 23, 112: 3, 150: 2, 100: 4, 75: 12, 132: 2, 114: 3, 86: 4, 128: 4, 70: 21, 106: 5, 115: 4, 166: 2, 81: 5, 411: 1, 308: 1, 134: 1, 71: 6, 347: 1, 320: 1, 167: 1, 87: 4, 162: 1, 120: 4, 187: 1, 157: 3, 93: 5, 363: 1, 88: 6, 113: 2, 108: 4, 127: 2, 159: 1, 194: 1, 133: 3, 154: 1, 110: 2, 140: 2, 200: 1, 160: 1, 214: 1, 168: 2, 130: 1, 109: 3, 131: 2, 255: 1, 118: 5, 180: 1, 174: 1, 119: 3, 142: 1, 171: 1, 176: 1, 136: 1, 143: 1, 156: 2, 192: 1, 179: 1, 181: 1, 145: 1, 185: 1, 117: 2}

# list(sorted(a.items(), key = lambda x: -x[0]))
# [(1498104, 1), (421, 1), (411, 1), (376, 1), (363, 1), (356, 1), (347, 1), (320, 1), (310, 1), (308, 1), (267, 1), (255, 1), (249, 1), (221, 2), (214, 1), (200, 1), (194, 1), (193, 2), (192, 1), (187, 1), (185, 1), (184, 2), (182, 2), (181, 1), (180, 1), (179, 1), (176, 1), (174, 1), (171, 1), (168, 2), (167, 1), (166, 2), (162, 1), (160, 1), (159, 1), (157, 3), (156, 2), (154, 1), (151, 2), (150, 2), (149, 3), (148, 1), (146, 2), (145, 1), (144, 1), (143, 1), (142, 1), (140, 2), (139, 5), (136, 1), (134, 1), (133, 3), (132, 2), (131, 2), (130, 1), (129, 3), (128, 4), (127, 2), (126, 3), (125, 5), (124, 2), (123, 2), (122, 3), (121, 3), (120, 4), (119, 3), (118, 5), (117, 2), (115, 4), (114, 3), (113, 2), (112, 3), (111, 4), (110, 2), (109, 3), (108, 4), (107, 3), (106, 5), (105, 8), (104, 5), (103, 4), (102, 6), (101, 6), (100, 4), (99, 5), (98, 9), (97, 13), (96, 9), (95, 10), (94, 7), (93, 5), (92, 4), (91, 8), (90, 7), (89, 10), (88, 6), (87, 4), (86, 4), (85, 13), (84, 7), (83, 10), (82, 13), (81, 5), (80, 11), (79, 8), (78, 14), (77, 16), (76, 12), (75, 12), (74, 11), (73, 22), (72, 18), (71, 6), (70, 21), (69, 19), (68, 18), (67, 32), (66, 28), (65, 34), (64, 30), (63, 14), (62, 26), (61, 30), (60, 32), (59, 37), (58, 40), (57, 28), (56, 36), (55, 23), (54, 47), (53, 39), (52, 43), (51, 40), (50, 69), (49, 59), (48, 49), (47, 32), (46, 55), (45, 52), (44, 57), (43, 71), (42, 99), (41, 66), (40, 99), (39, 62), (38, 138), (37, 98), (36, 114), (35, 101), (34, 140), (33, 101), (32, 126), (31, 96), (30, 188), (29, 167), (28, 202), (27, 189), (26, 235), (25, 224), (24, 237), (23, 217), (22, 303), (21, 323), (20, 285), (19, 311), (18, 448), (17, 413), (16, 537), (15, 594), (14, 928), (13, 1528), (12, 3283), (11, 1790), (10, 2649), (9, 2327), (8, 3821), (7, 5318), (6, 6270), (5, 15759), (4, 62352), (3, 16557), (2, 50365), (1, 157073)]

dump_obj('components_no_high_degree.pkl', sets.components())
